<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>실시간 접수 상황 확인 페이지</title>

  {% include 'center/layout/head.html' %}


  <style>
    /* content*/
    .content {
      width: 83%;
      height: 80%;
      float: left;
      color: black;
      padding-top: 17px;
      padding-right: 30px;
      font-size: 18px;
      font-family: 'Noto Sans KR', sans-serif;
    }

    .table {
      border: 1.6px solid black;
      text-align: center;
    }

    /* 버튼 안 글씨 크기 조절 */
    .btn-detail-ask {
      font-size: 16px;
    }

    /* 체크박스 스타일*/
    .form-check-input {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      outline: none;
      width: 22px;
      height: 22px;
      border: 3px solid black;
      border-radius: 3px;
      cursor: pointer;
    }

    .form-check-input:checked {
      background-color: black;
      border-color: black;
    }
  </style>


  <script>

    $(function () {

      function getRealtimeOrderList() {
        $.ajax({
          url: "http://localhost:8000/center/realtimeorder/get/",
          method: "GET",
        }).done(function (response) {
          console.log(response);

          const tr_array = response.map((getrealtimeorder, index) => {

            let orderKindText = "";
            let orderButtonColor = "";
            let ordertime = "";
            let realdatetime = '';

            response.sort(function (a, b) {
              const dateA = new Date(a.realdatetime);
              const dateB = new Date(b.realdatetime);
              return dateB.getTime() - dateA.getTime();
            });

            // order_kind에 따라 다른 값을 할당
            if (getrealtimeorder.order_kind === "order") {
              orderKindText = "주문";
              orderButtonColor = "danger";
              ordertime = getrealtimeorder.created_at.slice(11, 19);
              realdatetime = getrealtimeorder.created_at;
            } else if (getrealtimeorder.order_kind === "change") {
              orderKindText = "변경";
              orderButtonColor = "warning";
              ordertime = getrealtimeorder.updated_at.slice(11, 19);
              realdatetime = getrealtimeorder.updated_at;
            } else if (getrealtimeorder.order_kind === "cancel") {
              orderKindText = "취소";
              orderButtonColor = "success";
              ordertime = getrealtimeorder.updated_at.slice(11, 19);
              realdatetime = getrealtimeorder.updated_at;
            }

            let actionElement;

            if (getrealtimeorder.order_type === true) {

              // If order_type === true, 버튼
              actionElement = $(`
          <button id="${getrealtimeorder.id}" class="btn btn-${orderButtonColor} btn-sm btn-detail-ask"
            data-toggle="tooltip" title="클릭 시 고객님께 정보가 전송">
            ${orderKindText}요청
          </button>
        `);

            } else {

              // If order_type === false, 텍스트
              actionElement = $("<span>")
                .text(orderKindText + "완료")
                .attr("id", "ask_text")
                .addClass(`text-${orderButtonColor}`)
                .css("font-weight", "bold");

            }

            // ordertime 최근 것이 맨 위
            response.sort(function (a, b) {
              return new Date(a.ordertime) - new Date(b.ordertime);
            });

            return $(
              `<tr>
          <td>${index + 1}</td>
          <td>${getrealtimeorder.phone_number}</td>
          <td>${getrealtimeorder.gear_type}</td>
          <td>${getrealtimeorder.start_address}</td>
          <td>${getrealtimeorder.end_address}</td>
          <td>${ordertime}</td>
          <td>
            ${actionElement.prop('outerHTML')}
          </td>
          <td>
            <input class="form-check-input" type="checkbox" value="" id="flexCheckDefault" 
              data-toggle="tooltip" title="클릭 시 오늘 접수 목록으로 이동"
              data-pkkey="${getrealtimeorder.id}" data-ordertype="${getrealtimeorder.order_type}">
          </td>
        </tr>`
            );
          });

          $("#data_table > tbody").append(tr_array);
        });
      }
      getRealtimeOrderList();

    });


    // 접수, 변경, 취소 요청 시 (버튼 처리)
    $(document).on("click", ".btn-detail-ask", function () {

      const button = $(this);
      const orderKindText = button.text();
      const changeText = orderKindText.replace("요청", "") + "완료";
      const orderId = button.data("order-id");
      const buttonClasses = button.attr("class");
      const orderButtonColor = buttonClasses.split("btn-")[1].split(" ")[0];

      const spanElement = $("<span>")
        .text(changeText)
        .attr("id", "ask_text")
        .addClass(`text-${orderButtonColor}`)
        .css("font-weight", "bold");

      button.replaceWith(spanElement);

      const pkKey = button.attr("id");


      // PUT - 접수 상태 변경 요청
      $.ajax({

        url: `/center/realtimeorder/get/${pkKey}/`,
        method: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify({ order_type: false }),

        success: function (response) {
          console.log(response);

          // 체크박스 클릭
          $(document).on("click", ".form-check-input", function () {

            const isChecked = $(this).prop("checked");
            const pkKey = $(this).data("pkkey");

            if (isChecked) {
              $.ajax({
                url: `/center/realtimeorder/get/${pkKey}/`,
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({ is_hide: true }),
                success: function (response) {
                  console.log(response);
                },
                error: function (xhr, status, error) {
                  console.error(xhr.responseText);
                }
              });

            }
          });
        },

        error: function (xhr, status, error) {
          console.error(xhr.responseText);
        }
      });
    });


    // 체크박스 클릭
    $(document).on("click", ".form-check-input", function () {

      const isChecked = $(this).prop("checked");
      const pkKey = $(this).data("pkkey");
      const orderType = $(this).data("ordertype");

      if (isChecked && orderType == false) {
        $.ajax({
          url: `/center/realtimeorder/get/${pkKey}/`,
          method: 'PUT',
          contentType: 'application/json',
          data: JSON.stringify({ is_hide: true }),
          success: function (response) {
            console.log(response);
          },
          error: function (xhr, status, error) {
            console.error(xhr.responseText);
          }
        });

      }
    });


    // tooltip
    $(function () {
      $('[data-toggle="tooltip"]').tooltip();
    });


    // 5초(5000ms)마다 페이지를 다시 로드하는 함수
    function reloadPage() {
      location.reload();
    }

    setInterval(reloadPage, 5000);

  </script>

</head>

<body>
  <div class="container-fluid">
    <div class="row">
      {% include 'center/layout/base.html' %}
      <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 mt-3">
        <h3>실시간 접수 상황</h3>
        <div class="table-responsive">
          <table class="table table-striped table-sm" id="data_table">
            <thead>
              <tr>
                <th scope="col"></th>
                <th scope="col">전화번호</th>
                <th scope="col">기어</th>
                <th scope="col">출발지</th>
                <th scope="col">목적지</th>
                <th scope="col">등록시간</th>
                <th scope="col">접수상황</th>
                <th scope="col">최종확인</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="pagination" id="paginationDiv"></div>
      </main>
    </div>
  </div>

</body>

</html>